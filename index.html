<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">

  <link rel="stylesheet" href="styles.css">

  <title>The Duality Programming Language</title>
</head>

<body>
  <div id="code-box">
    <textarea id="code-textarea" placeholder="Enter code here..." spellcheck="false"></textarea>

    <div id="code-result-divider"></div>

    <div id="result-div"></div>
  </div>

  <script src="dy.js"></script>

  <script src="processCode.js"></script>

  <script>
    'use strict'

    let timeoutId

    const processCodeAndDisplay = () => {
      const code = document.getElementById('code-textarea').value
      if (!code) {
        document.getElementById('result-div').textContent = ''
        return
      }

      document.getElementById('result-div').textContent = processCode(code)

      timeoutId = undefined
    }

    const textArea = document.getElementById('code-textarea')

    const savedData = window.sessionStorage.getItem('code')
    if (savedData) {
      textArea.value = savedData
      timeoutId = window.setTimeout(processCodeAndDisplay, 1000 * 2)
    }

    textArea.addEventListener('input', () => {
      window.sessionStorage.setItem('code', textArea.value)

      if (timeoutId) {
        window.clearTimeout(timeoutId)
      }

      timeoutId = window.setTimeout(processCodeAndDisplay, 1000 * 0.3)
    })

    textArea.addEventListener('keydown', event => {
      if (event.isComposing || event.keyCode === 229) {
        return
      }

      if (event.key != "Tab") {
        return
      }

      event.preventDefault()

      if (textArea.selectionStart || textArea.selectionStart === 0) {
        const startPos = textArea.selectionStart
        const endPos = textArea.selectionEnd

        textArea.value = textArea.value.substring(0, startPos) + '\t' + textArea.value.substring(endPos, textArea.value.length)
        textArea.selectionStart = startPos + 1
        textArea.selectionEnd = startPos + 1
      } else {
        textArea.value += text
      }
    })
  </script>
</body>

</html>